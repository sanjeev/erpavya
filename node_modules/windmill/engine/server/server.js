var path = require('path'),
    colorize = require('colorize'),
    hbs = require('hbs'),
    fs = require('fs'),
    posts = require(path.join(__dirname, '/posts'));
    config = require(path.join(__dirname, '../../config.json'));

module.exports = {
    start: function() {
        var express = require('express');
        var app = express();
        
        app.set('view engine', 'hbs');
        app.set('view engine', 'html');
        app.engine('html', require('hbs').__express);
        
        var config_port = (typeof config.port !== undefined) ? config.port : 3000;
        var port = (process.env.PORT != null) ? process.env.PORT : config_port;
                
        app.listen(port);
        
        registerPartials(hbs);
        
        app.get('/', function(req, res){
            
            res.render(path.join(__dirname, '../../theme/list.html'), {
               posts: posts.getAll(),
               config : config
            });
            
        });
        
        app.get('/posts/:filename', function(req, res){
            res.render(path.join(__dirname, '../../theme/single.html'), {
               post: posts.getByName(req.params.filename + '.post'),
               config : config
            });
            
        });
        
        app.get('/js/client.js', function(req, res) {
            var content = fs.readFileSync(path.join(__dirname, '../client/client.js'));
            
            res.setHeader('Content-Type', 'text/plain');
            res.setHeader('Content-Length', content.toString().length);
            res.end(content.toString()); 
        });
        
        app.use("/css", express.static(path.join(__dirname, '../../public/css')));
        app.use("/js", express.static(path.join(__dirname, '../../public/js')));
        app.use("/img", express.static(path.join(__dirname, '../../public/img')));
        
        console.log(colorize.ansify('#blue[windmill] started on port ' + port));
    }
};

function registerPartials(hbs) {
    var post = fs.readFileSync(path.join(__dirname, '../../theme/partials/post.html'));
    hbs.registerPartial('post', post.toString());

    var header = fs.readFileSync(path.join(__dirname, '../../theme/partials/header.html'));
    hbs.registerPartial('header', header.toString());

    var footer = fs.readFileSync(path.join(__dirname, '../../theme/partials/footer.html'));
    hbs.registerPartial('footer', footer.toString());
}